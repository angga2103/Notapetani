<!DOCTYPE html>
<html lang="id" class="bg-gray-100">
<head>
    <meta charset="UTF-8">
    <title>Nota Thermal Petani - Rapi & Responsif</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    	      <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      /* Style untuk Nota Cetak Thermal 58mm */
      @media print {
        body, .print-container { width: 58mm !important; max-width: 58mm !important; margin: 0; padding: 0; background: #fff; font-size: 12px; }
        .no-print { display: none !important;}
        html, body { background-color: #fff !important; }
      }
      /* Font Monospace untuk Pratinjau Nota */
      .nota-mono { font-family: 'Courier New', Courier, monospace; font-size: 13px; white-space: pre; }

      /* CSS untuk Autocomplete */
      .autocomplete-container { position: relative; }
      .autocomplete-suggestions {
        position: absolute; border: 1px solid #d1d5db; background-color: #fff; z-index: 99;
        max-height: 150px; overflow-y: auto; width: 100%; border-radius: 0 0 0.5rem 0.5rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .autocomplete-suggestions div { padding: 0.5rem; cursor: pointer; font-size: 14px; }
      .autocomplete-suggestions div:hover { background-color: #f3f4f6; }
      .autocomplete-suggestions .active { background-color: #3b82f6; color: #fff; }
 /* CSS untuk Sorting */
      .sortable { cursor: pointer; user-select: none; }
      .sortable:hover { color: #1d4ed8; }
    </style>
</head>
<body class="py-8 px-4">

<div id="backupReminder" class="no-print hidden fixed top-0 left-0 right-0 bg-yellow-100 border-b border-yellow-300 p-3 text-center text-sm text-yellow-800 shadow-lg z-50 flex justify-between items-center">
    <span>
<span class="font-bold">Pengingat:</span> Sudah waktunya untuk mengamankan data Anda.
<button onclick="performBackupFromReminder()" class="font-bold underline hover:text-yellow-900 ml-2">
    Backup Sekarang
</button>
<span class="block mt-2 text-sm">
    Untuk informasi hubungi: <span class="font-bold">
    <a href="https://wa.me/6281775700114" target="_blank" class="text-blue-600 underline hover:text-green-600">
        MasAnsor </span>
    </a>.
</span>
    <button onclick="dismissBackupReminder()" class="font-bold text-xl leading-none px-2" title="Tutup Nanti">&times;</button>
</div>
<div class="print-container mx-auto bg-white rounded-lg shadow-sm p-3 max-w-xs mb-6 border">
  <pre id="previewNota" class="nota-mono"></pre>
</div>

<div class="no-print max-w-md mx-auto bg-white rounded-xl shadow-md p-6 space-y-6">

  <h1 class="text-2xl font-bold text-gray-800 text-center">Nota Petani</h1>

  <div class="space-y-4">
    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Informasi Nota</h2>
    <input type="hidden" id="editIndex" value="">
    <div>
      <label for="iNama" class="block text-sm font-medium text-gray-600 mb-1">Nama Toko</label>
      <input id="iNama" class="border-gray-300 rounded-lg shadow-sm w-full p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="" autocomplete="off">
    </div>
    <div>
      <label for="iAlamat" class="block text-sm font-medium text-gray-600 mb-1">Alamat</label>
      <input id="iAlamat" class="border-gray-300 rounded-lg shadow-sm w-full p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="" autocomplete="off">
    </div>
    <div>
      <label for="iTelp" class="block text-sm font-medium text-gray-600 mb-1">No. WA</label>
      <input id="iTelp" class="border-gray-300 rounded-lg shadow-sm w-full p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="" autocomplete="off" inputmode="numeric">
    </div>
    <div class="autocomplete-container">
      <label for="iPetani" class="block text-sm font-medium text-gray-600 mb-1">Nama Petani</label>
      <input id="iPetani" class="border-gray-300 rounded-lg shadow-sm w-full p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="" autocomplete="off">
    </div>
    <div>
        <label for="iTanggal" class="block text-sm font-medium text-gray-600 mb-1">Tanggal & Jam</label>
        <div class="flex gap-2">
            <input id="iTanggal" class="border-gray-300 rounded-lg shadow-sm flex-1 p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" type="datetime-local" value="">
            <button type="button" onclick="isiTanggalOtomatis()" class="bg-gray-200 text-gray-700 px-3 rounded-lg text-sm font-semibold hover:bg-gray-300 transition-colors">Sekarang</button>
        </div>
    </div>
  </div>

  <div class="space-y-4">
    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Data Barang</h2>
    <div id="isiBarang" class="space-y-3"></div>
    <button type="button" onclick="tambahBarang()" class="w-full bg-blue-100 text-blue-800 text-sm p-2 rounded-lg font-semibold hover:bg-blue-200 transition-colors">+ Tambah Barang</button>
  </div>

  <div class="space-y-3 pt-4 border-t">
    <button type="button" id="btnSimpan" onclick="simpanTransaksi()" class="w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow-sm">Simpan Nota</button>
    <div class="grid grid-cols-3 gap-3">
        <button type="button" onclick="salinNota()" class="bg-gray-100 border border-gray-300 text-gray-800 py-2 rounded-lg hover:bg-gray-200 transition-colors">Salin Teks</button>
        <button type="button" onclick="window.print()" class="bg-gray-100 border border-gray-300 text-gray-800 py-2 rounded-lg hover:bg-gray-200 transition-colors">Cetak Nota</button>
        <button type="button" onclick="generatePDF()" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-colors font-semibold">Cetak PDF</button>
    </div>
    <textarea id="textNotaRingkas" rows="6" class="w-full border-gray-300 rounded-lg p-2 text-xs nota-mono" readonly></textarea>
  </div>

  <div class="space-y-3">
     <button type="button" onclick="tampilkanRekap()" class="w-full bg-purple-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-purple-700 transition-colors shadow-sm">Buka Rekap Petani</button>
     <div id="rekapArea" class="mt-4 space-y-3"></div>
     <button type="button" id="btnExportCsv" onclick="exportToCSV()" class="w-full bg-green-700 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-green-800 transition-colors shadow-sm hidden">Ekspor Rekap ke CSV (Excel)</button>
  </div>

  <div class="flex gap-3 pt-4 border-t">
    <button type="button" onclick="backupData()" class="w-full bg-yellow-400 text-yellow-900 font-semibold py-2 rounded-lg hover:bg-yellow-500 transition-colors">Backup Data</button>
    <label class="flex-1 bg-gray-600 text-white font-semibold py-2 rounded-lg hover:bg-gray-700 transition-colors text-center cursor-pointer">
        Restore Data
        <input type="file" id="importFile" accept=".json" onchange="importData(this)" class="hidden">
    </label>
  </div>

  <div class="pt-4 border-t mt-4">
      <button type="button" onclick="closeApp()" class="w-full bg-red-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-red-700 transition-colors shadow-sm">Tutup Aplikasi</button>
  </div>
</div>

<div class="no-print text-center mt-6 text-sm text-gray-500">
    <p>Developer by <a href="https://wa.me/6281775700114" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-600 hover:text-blue-500 underline">Mas Ansor</a></p>
</div>

<script>
	if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(registration => console.log('Service Worker berhasil didaftarkan.'))
      .catch(err => console.log('Pendaftaran Service Worker gagal: ', err));
  });
}


const LS_KEY = "nota58_petani";
let lastEnterPressTime = 0;
let sortState = { key: 'tanggal', direction: 'desc' };
let rekapChart = null;

// --- FUNGSI BARU: Tutup Aplikasi ---
function closeApp() {
    if (confirm("Apakah anda akan menutupnya?")) {
        // Catatan: window.close() mungkin tidak berfungsi pada semua browser modern
        // jika jendela tidak dibuka oleh skrip, tetapi ini adalah metode standarnya.
        window.close();
    }
}

// --- BAGIAN BARU: Fungsi untuk Generate PDF ---
async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const data = getNotaForm();

    if (!data.petani) { alert("Isi nama petani dahulu!"); return; }
    if (!data.barang.some(b => b.nama && b.qty)) { alert("Data barang masih kosong!"); return; }

    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: [58, 210]
    });

    const margin = 3;
    const maxWidth = 58;
    let y = 7;

    doc.setFont('Courier', 'normal');
    doc.setFontSize(11).setFont('Courier', 'bold');
    doc.text(data.nama, maxWidth / 2, y, { align: 'center' });
    y += 4;
    doc.setFontSize(8).setFont('Courier', 'normal');
    doc.text(data.alamat, maxWidth / 2, y, { align: 'center' });
    y += 3;
    doc.text(`WA: ${data.telp}`, maxWidth / 2, y, { align: 'center' });
    y += 4;
    doc.text('---------------------------------', maxWidth / 2, y, { align: 'center' });
    y += 4;

    doc.text(`Petani: ${data.petani}`, margin, y);
    y += 4;
    doc.text(`Tanggal: ${formatTanggalNota(data.tanggal)}`, margin, y);
    y += 4;
    doc.text('---------------------------------', maxWidth / 2, y, { align: 'center' });
    y += 5;

    doc.setFontSize(9);
    const barangMap = new Map();
    let totalHarga = 0;
    // --- MODIFIKASI: Struktur data baru untuk rincian item ---
    const itemDetails = {};

    (data.barang || []).forEach(b => {
        if (!b.nama) return;
        // --- MODIFIKASI: Mengisi struktur data baru ---
        if (!itemDetails[b.nama]) {
            itemDetails[b.nama] = [];
        }
        itemDetails[b.nama].push(b.qty.trim() || '0');

        let key = b.nama.toLowerCase() + "|" + b.satuan + "|" + b.harga;
        let qty = parseFloatSafe(b.qty);
        let harga = parseFloatSafe(b.harga);
        let total = qty * harga;
        totalHarga += total;
        if (barangMap.has(key)) {
            let t = barangMap.get(key);
            t.qty += qty;
            t.total += total;
        } else {
            barangMap.set(key, { nama: b.nama, satuan: b.satuan, harga: harga, qty: qty, total: total });
        }
    });

    barangMap.forEach(item => {
        doc.setFont('Courier', 'bold');
        doc.text(item.nama, margin, y);
        y += 4;

        doc.setFont('Courier', 'normal');
        let qtyStr = (item.qty % 1 === 0) ? item.qty : item.qty.toFixed(2).replace(".", ",");
        let hargaStr = formatRupiah(item.harga);
        let totalStr = formatRupiah(item.total);

        let leftText = `${qtyStr} ${item.satuan} x @${hargaStr}`;
        doc.text(leftText, margin, y);
        doc.text(totalStr, maxWidth - margin, y, { align: 'right' });
        y += 4;
    });

    y += 2;
    doc.text('---------------------------------', maxWidth / 2, y, { align: 'center' });
    y += 5;

    doc.setFontSize(10).setFont('Courier', 'bold');
    doc.text('TOTAL', margin, y);
    doc.text(`Rp ${formatRupiah(totalHarga)}`, maxWidth - margin, y, { align: 'right' });
    y += 5;

    doc.setFontSize(8).setFont('Courier', 'normal');
    doc.text('---------------------------------', maxWidth / 2, y, { align: 'center' });
    y += 5;

    doc.setFont('Courier', 'bold');
    doc.text('Keterangan Item:', margin, y);
    y += 4;
    doc.setFont('Courier', 'normal');
    let totalItem = 0;
    // --- MODIFIKASI: Logika baru untuk menampilkan rincian item di PDF ---
    for (const itemName in itemDetails) {
        const quantities = itemDetails[itemName];
        const count = quantities.length;
        totalItem += count;
        const qtyString = quantities.join(', ');
        const fullText = `${itemName} (${count}) : ${qtyString}`;
        
        // Menangani teks yang terlalu panjang agar pas di lebar nota
        const splitText = doc.splitTextToSize(fullText, maxWidth - margin * 2);
        doc.text(splitText, margin, y);
        y += (splitText.length * 3.5); // Sesuaikan posisi Y berdasarkan jumlah baris
    }

    y += 1;
    doc.text(`Jumlah item: ${totalItem}`, margin, y);
    y += 7;

    doc.text('Terima kasih!', maxWidth / 2, y, { align: 'center' });

    const tglFile = new Date().toISOString().slice(0, 10);
    doc.save(`nota-${data.petani.replace(/\s/g, '_')}-${tglFile}.pdf`);
}


// --- Logika Autocomplete Cerdas ---
function getPetaniList() {
    const db = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
    return Object.keys(db).sort();
}
function getBarangList() {
    const db = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
    const barangSet = new Set();
    for (const petani in db) {
        if (db[petani]) {
            db[petani].forEach(trx => {
                if (trx.barang) {
                    trx.barang.forEach(b => {
                        if (b.nama) barangSet.add(b.nama.trim());
                    });
                }
            });
        }
    }
    return Array.from(barangSet).sort();
}
function initAutocomplete(inputEl, sourceFunc) {
    let activeSuggestion = -1;
    let suggestionsContainer;
    inputEl.addEventListener('input', function(e) {
        const val = this.value;
        closeAllLists();
        if (!val) { return false; }
        const source = sourceFunc();
        suggestionsContainer = document.createElement("DIV");
        suggestionsContainer.setAttribute("class", "autocomplete-suggestions");
        this.parentNode.appendChild(suggestionsContainer);
        let count = 0;
        source.forEach(item => {
            if (item.substr(0, val.length).toUpperCase() == val.toUpperCase() && count < 7) {
                const suggestionDiv = document.createElement("DIV");
                suggestionDiv.innerHTML = "<strong>" + item.substr(0, val.length) + "</strong>";
                suggestionDiv.innerHTML += item.substr(val.length);
                suggestionDiv.dataset.value = item;
                suggestionDiv.addEventListener("click", function(e) {
                    inputEl.value = this.dataset.value;
                    inputEl.dispatchEvent(new Event('input', { bubbles: true }));
                    closeAllLists();
                    const itemContainer = inputEl.closest('.barang-container');
                    if (itemContainer) {
                        const qtyInput = itemContainer.querySelector('.qty');
                        if (qtyInput) { qtyInput.focus(); }
                    }
                });
                suggestionsContainer.appendChild(suggestionDiv);
                count++;
            }
        });
    });
    inputEl.addEventListener('keydown', function(e) {
        let x = suggestionsContainer;
        if (x) x = x.getElementsByTagName("div");
        if (!x) return;
        if (e.keyCode == 40) { activeSuggestion++; addActive(x); }
        else if (e.keyCode == 38) { activeSuggestion--; addActive(x); }
        else if (e.keyCode == 13) { if (activeSuggestion > -1) { e.preventDefault(); x[activeSuggestion].click(); activeSuggestion = -1; } }
        else if (e.keyCode == 27) { closeAllLists(); }
    });
    function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (activeSuggestion >= x.length) activeSuggestion = 0;
        if (activeSuggestion < 0) activeSuggestion = (x.length - 1);
        x[activeSuggestion].classList.add("active");
    }
    function removeActive(x) {
        for (let i = 0; i < x.length; i++) { x[i].classList.remove("active"); }
    }
    function closeAllLists(elmnt) {
        const items = document.getElementsByClassName("autocomplete-suggestions");
        for (let i = 0; i < items.length; i++) {
            if (elmnt != items[i] && elmnt != inputEl) {
                items[i].parentNode.removeChild(items[i]);
            }
        }
    }
    document.addEventListener("click", function (e) { closeAllLists(e.target); });
}

function isiTanggalOtomatis() {
  let t = new Date();
  let y = t.getFullYear(), m = String(t.getMonth()+1).padStart(2,"0"), d = String(t.getDate()).padStart(2,"0");
  let H = String(t.getHours()).padStart(2,"0"), M = String(t.getMinutes()).padStart(2,"0");
  document.getElementById('iTanggal').value = y+'-'+m+'-'+d+'T'+H+':'+M;
  renderNota();
}

function formatTanggalNota(val) {
  if(!val) return '';
  let d = new Date(val);
  if(isNaN(d)) return val;
  let tgl = String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear();
  let jam = String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
  return tgl+" "+jam;
}

function padBoth(left, right, width) {
  let space = width - (left.length + right.length);
  if (space < 1) space = 1;
  return left + ' '.repeat(space) + right;
}

function formatRupiah(val) {
  if(!val) return '';
  return Number(val).toLocaleString('id-ID');
}

function parseFloatSafe(numStr) {
    if (typeof numStr !== 'string') return 0;
    return parseFloat(numStr.replace(/\./g, '').replace(',', '.')) || 0;
}

function getTrxTotal(trx) {
    return (trx.barang || []).reduce((sum, b) => sum + (parseFloatSafe(b.qty) * parseFloatSafe(b.harga)), 0);
}

function tambahBarang(obj={}) {
  const div = document.createElement('div');
  div.className = "flex items-center gap-2 p-2 border rounded-lg bg-gray-50 barang-container";
  div.innerHTML = `
    <div class="flex-1 space-y-1">
        <div class="autocomplete-container">
            <input class="nama border-gray-300 rounded-md w-full p-1.5 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Nama Barang" value="${obj.nama||''}" autocomplete="off">
        </div>
        <div class="flex gap-2">
            <input class="qty border-gray-300 rounded-md w-1/3 p-1.5 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500" type="text" inputmode="decimal" placeholder="Qty" value="${obj.qty||''}" autocomplete="off">
            <span class="satuan self-center text-sm font-medium text-gray-600 w-8 text-center">${(obj.nama && obj.nama.toLowerCase() === 'blonceng') ? 'Biji' : (obj.satuan || 'Kg')}</span>
            <input class="harga border-gray-300 rounded-md flex-1 p-1.5 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500" type="text" inputmode="decimal" placeholder="Harga/Satuan" value="${obj.harga||''}" autocomplete="off">
        </div>
    </div>
    <button type="button" onclick="this.parentNode.remove();renderNota()" title="Hapus" class="bg-red-100 text-red-700 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xl hover:bg-red-200 transition-all">&times;</button>
  `;
  const inpNama = div.querySelector('.nama');
  const inpQty = div.querySelector('.qty');
  const inpHarga = div.querySelector('.harga');
  initAutocomplete(inpNama, getBarangList);
  inpNama.addEventListener('input', function() {
    div.querySelector('.satuan').textContent = (inpNama.value.trim().toLowerCase() === "blonceng" ? "Biji" : "Kg");
    renderNota();
  });
  inpQty.addEventListener('input', renderNota);
  inpHarga.addEventListener('input', function(e) {
    if (e.target.value.includes('..')) {
        const namaBarangSebelumnya = inpNama.value;
        const qtySebelumnya = inpQty.value;
        e.target.value = e.target.value.replace('..', '');
        tambahBarang({ nama: namaBarangSebelumnya, qty: qtySebelumnya });
        const allHargaInputs = document.querySelectorAll('#isiBarang .harga');
        const lastHargaInput = allHargaInputs[allHargaInputs.length - 1];
        if (lastHargaInput) { lastHargaInput.focus(); }
    }
    renderNota();
  });
  inpHarga.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const now = new Date().getTime();
        const timeDiff = now - lastEnterPressTime;
        if (timeDiff < 500) {
            tambahBarang();
            const allNamaInputs = document.querySelectorAll('#isiBarang .nama');
            const lastNamaInput = allNamaInputs[allNamaInputs.length - 1];
            if (lastNamaInput) { lastNamaInput.focus(); }
            lastEnterPressTime = 0;
        } else {
            lastEnterPressTime = now;
        }
    }
  });
  document.getElementById('isiBarang').appendChild(div);
  renderNota();
}

// --- FUNGSI renderNota DIMODIFIKASI ---
function renderNota() {
  const data = getNotaForm();
  let hasil = `${data.nama}\n${data.alamat} | Wa:${data.telp}\n${(data.petani?data.petani+" | ":"")}${formatTanggalNota(data.tanggal)}\n==============================\n`;
  const barangMap = new Map();
  // --- MODIFIKASI: Struktur data baru untuk rincian item ---
  const itemDetails = {};
  let totalItem = 0, totalHarga = 0;

  (data.barang||[]).forEach(b=>{
    if(!b.nama) return;

    // --- MODIFIKASI: Mengisi struktur data baru ---
    if (!itemDetails[b.nama]) {
      itemDetails[b.nama] = [];
    }
    itemDetails[b.nama].push(b.qty.trim() || '0');

    let key = b.nama.toLowerCase()+"|"+b.satuan+"|"+b.harga;
    let qty = parseFloatSafe(b.qty);
    let harga = parseFloatSafe(b.harga);
    if(barangMap.has(key)){
      let t=barangMap.get(key); t.qty+=qty; t.total+=qty*harga;
    } else {
      barangMap.set(key,{nama:b.nama,satuan:b.satuan,harga:harga,qty:qty,total:qty*harga});
    }
    totalItem++;
    totalHarga+=qty*harga;
  });

  barangMap.forEach(item=>{
    let qtyStr = (item.qty%1===0) ? item.qty : item.qty.toFixed(2).replace(".",",");
    if(item.harga > 0){
      hasil += `${item.nama}\n` + padBoth(`${qtyStr} ${item.satuan} Ã— ${formatRupiah(item.harga)}`, formatRupiah(item.total), 32) + "\n";
    } else {
      hasil += padBoth(item.nama, `${qtyStr} ${item.satuan}`, 32) + "\n";
    }
  });

  hasil += "==============================\n";
  if(totalHarga > 0) hasil += padBoth("Total:", formatRupiah(totalHarga), 32) + "\n";

  // --- MODIFIKASI: Logika baru untuk menampilkan rincian item ---
  hasil += "Keterangan item:\n";
  for(const itemName in itemDetails) {
      const quantities = itemDetails[itemName];
      const count = quantities.length;
      const qtyString = quantities.join(', ');
      hasil += `${itemName} (${count}) : ${qtyString}\n`;
  }

  hasil += `Jumlah item : ${totalItem}`;
  document.getElementById('previewNota').textContent = hasil;
  document.getElementById('textNotaRingkas').value = hasil;
}


function getNotaForm() {
  return {
    nama: document.getElementById('iNama').value.trim(),
    alamat: document.getElementById('iAlamat').value.trim(),
    telp: document.getElementById('iTelp').value.trim(),
    petani: document.getElementById('iPetani').value.trim(),
    tanggal: document.getElementById('iTanggal').value,
    barang: Array.from(document.querySelectorAll('#isiBarang .barang-container')).map(div=>({
      nama: div.querySelector('.nama').value.trim(),
      qty: div.querySelector('.qty').value.trim(),
      satuan: div.querySelector('.satuan').textContent.trim(),
      harga: div.querySelector('.harga').value.trim()
    }))
  }
}

function salinNota() {
  const ta = document.getElementById('textNotaRingkas');
  const btn = document.querySelector('button[onclick="salinNota()"]');
  const originalText = btn ? btn.textContent : 'Salin Text';
  try {
    ta.select();
    ta.setSelectionRange(0, 99999);
    document.execCommand('copy');
    if (btn) {
        btn.textContent='Tersalin!';
        setTimeout(()=> { btn.textContent = originalText; }, 1500);
    }
  } catch (err) {
    console.error("Gagal menyalin: ", err);
    if (btn) {
        btn.textContent = 'Gagal Salin';
        setTimeout(()=> { btn.textContent = originalText; }, 2000);
    }
  }
}

function simpanTransaksi() {
  const obj = getNotaForm();
  if(!obj.petani){ alert("Isi nama petani dahulu!"); return; }
  if(!obj.barang.some(b => b.nama && b.qty)){ alert("Data barang masih kosong!"); return; }

  let db = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
  const editIndex = document.getElementById('editIndex').value;

  if (editIndex !== '') {
    db[obj.petani][parseInt(editIndex)] = obj;
  } else {
    if(!db[obj.petani]) db[obj.petani]=[];
    db[obj.petani].push(obj);
  }

  localStorage.setItem(LS_KEY, JSON.stringify(db));

  let trxCount = parseInt(localStorage.getItem('conf_transactionsSinceLastBackup') || '0');
  localStorage.setItem('conf_transactionsSinceLastBackup', trxCount + 1);

  salinNota();

  if (editIndex !== '') {
    alert("Transaksi berhasil diperbarui!");
    if (document.getElementById('rekapArea').innerHTML !== '') {
        showTabelRekap(obj.petani);
    }
  } else {
    alert("Transaksi berhasil disimpan!");
  }

  initForm();
}

function initForm() {
  document.getElementById('iNama').value = localStorage.getItem('conf_nama') || "Mas Angga";
  document.getElementById('iAlamat').value = localStorage.getItem('conf_alamat') || "Kebonrejo";
  document.getElementById('iTelp').value = localStorage.getItem('conf_telp') || "081775700114";
  document.getElementById('iPetani').value = "";
  document.getElementById('iPetani').readOnly = false;
  document.getElementById('iTanggal').value = "";
  document.getElementById('isiBarang').innerHTML = "";
  document.getElementById('editIndex').value = "";
  const btnSimpan = document.getElementById('btnSimpan');
  btnSimpan.textContent = "Simpan Nota";
  btnSimpan.classList.remove('bg-green-600');
  btnSimpan.classList.add('bg-blue-600');

  tambahBarang();
  document.querySelector('#isiBarang .nama').focus();
  renderNota();
  initAutocomplete(document.getElementById('iPetani'), getPetaniList);
}

function muatUlangTransaksi(petani, trxIndex) {
  const db = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
  const trx = db[petani]?.[trxIndex];
  if (!trx) { alert("Data transaksi tidak ditemukan!"); return; }

  document.getElementById('iNama').value = trx.nama;
  document.getElementById('iAlamat').value = trx.alamat;
  document.getElementById('iTelp').value = trx.telp;
  document.getElementById('iPetani').value = trx.petani;
  document.getElementById('iPetani').readOnly = true;
  document.getElementById('iTanggal').value = trx.tanggal;
  document.getElementById('editIndex').value = trxIndex;

  const btnSimpan = document.getElementById('btnSimpan');
  btnSimpan.textContent = "Update Nota";
  btnSimpan.classList.replace('bg-blue-600', 'bg-green-600');

  document.getElementById('isiBarang').innerHTML = '';
  if (trx.barang && trx.barang.length > 0) trx.barang.forEach(b => tambahBarang(b));
  else tambahBarang();

  renderNota();
  window.scrollTo(0, 0);
  alert(`Mode Edit untuk transaksi tanggal ${formatTanggalNota(trx.tanggal)}.`);
}

function hapusTransaksi(petani, trxIndex) {
  if (!confirm(`Apakah Anda yakin ingin menghapus transaksi ini secara permanen?`)) return;

  if (document.getElementById('editIndex').value === String(trxIndex) && document.getElementById('iPetani').value === petani) {
      initForm();
  }

  let db = JSON.parse(localStorage.getItem(LS_KEY));
  db[petani].splice(trxIndex, 1);
  if (db[petani].length === 0) delete db[petani];

  localStorage.setItem(LS_KEY, JSON.stringify(db));
  alert('Transaksi berhasil dihapus.');
  showTabelRekap(petani);
}

function tampilkanRekap() {
  const db = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
  const rekapArea = document.getElementById('rekapArea');

  if (rekapArea.innerHTML !== '') {
      rekapArea.innerHTML = '';
      document.getElementById('btnExportCsv').classList.add('hidden');
      if(rekapChart) rekapChart.destroy();
      return;
  }

  let html = `
    <div id="dashboardArea" class="mb-4">
      <h2 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-3">Dashboard</h2>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-center">
        <div class="bg-blue-100 p-3 rounded-lg">
          <div class="text-xs text-blue-800 uppercase font-semibold">Total Omzet</div>
          <div id="statTotalOmzet" class="text-lg md:text-xl font-bold text-blue-900">Rp 0</div>
        </div>
        <div class="bg-green-100 p-3 rounded-lg">
          <div class="text-xs text-green-800 uppercase font-semibold">Trx Hari Ini</div>
          <div id="statTrxHariIni" class="text-lg md:text-xl font-bold text-green-900">0</div>
        </div>
        <div class="bg-yellow-100 p-3 rounded-lg col-span-2 md:col-span-1">
          <div class="text-xs text-yellow-800 uppercase font-semibold">Petani Terbaik (Bulan Ini)</div>
          <div id="statPetaniTerbaik" class="text-lg md:text-xl font-bold text-yellow-900">-</div>
        </div>
      </div>
      <div class="mt-4">
        <canvas id="chart7Hari"></canvas>
      </div>
    </div>
    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2 mt-6">Detail Rekap</h2>
    <div class="space-y-3 p-3 bg-gray-50 rounded-lg border mt-3">
        <select id="pilihPetani" class="border-gray-300 rounded-lg shadow-sm w-full p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" onchange="showTabelRekap(this.value)">
            <option value="">-- Pilih Petani --</option>`;
  Object.keys(db).sort().forEach(p=>{ html+=`<option value="${p}">${p}</option>`; });
  html+=`</select>
        <input type="search" id="rekapSearch" oninput="showTabelRekap()" class="border-gray-300 rounded-lg shadow-sm w-full p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="ðŸ” Cari nama barang...">
        <div class="flex gap-2 items-center text-sm">
            <label for="rekapMulai" class="text-gray-600">Dari:</label>
            <input type="date" id="rekapMulai" onchange="showTabelRekap()" class="border-gray-300 rounded-lg shadow-sm w-full p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
            <label for="rekapSelesai" class="text-gray-600">Sampai:</label>
            <input type="date" id="rekapSelesai" onchange="showTabelRekap()" class="border-gray-300 rounded-lg shadow-sm w-full p-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
        </div>
    </div>
    <div id="tabelRekap" class="mt-4"></div>`;

  rekapArea.innerHTML = html;
  renderDashboard();
  showTabelRekap();
}

function renderDashboard() {
  const db = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
  let allTrx = Object.values(db).flat();
  let totalOmzet = 0;
  let trxHariIni = 0;
  const today = new Date().toISOString().slice(0, 10);
  const currentMonth = new Date().toISOString().slice(0, 7);
  let omzetPerPetaniBulanIni = {};

  allTrx.forEach(trx => {
    const trxTotal = getTrxTotal(trx);
    totalOmzet += trxTotal;
    if (trx.tanggal && trx.tanggal.slice(0, 10) === today) trxHariIni++;
    if (trx.tanggal && trx.tanggal.slice(0, 7) === currentMonth) {
        omzetPerPetaniBulanIni[trx.petani] = (omzetPerPetaniBulanIni[trx.petani] || 0) + trxTotal;
    }
  });

  let petaniTerbaik = '-';
  let maxOmzetBulanIni = 0;
  for(const petani in omzetPerPetaniBulanIni){
      if(omzetPerPetaniBulanIni[petani] > maxOmzetBulanIni){
          maxOmzetBulanIni = omzetPerPetaniBulanIni[petani];
          petaniTerbaik = petani;
      }
  }

  document.getElementById('statTotalOmzet').textContent = 'Rp ' + formatRupiah(totalOmzet);
  document.getElementById('statTrxHariIni').textContent = trxHariIni;
  document.getElementById('statPetaniTerbaik').textContent = petaniTerbaik;

  const labels = [];
  const dateMap = new Map();
  for (let i = 6; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    labels.push(`${day}/${month}`);
    dateMap.set(d.toISOString().slice(0, 10), 0);
  }

  allTrx.forEach(trx => {
    if (trx.tanggal) {
      const trxDate = trx.tanggal.slice(0, 10);
      if (dateMap.has(trxDate)) {
        dateMap.set(trxDate, dateMap.get(trxDate) + getTrxTotal(trx));
      }
    }
  });

  const data7hari = Array.from(dateMap.values());

  const ctx = document.getElementById('chart7Hari').getContext('2d');
  if(rekapChart) rekapChart.destroy();

  rekapChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Omzet per Hari',
        data: data7hari,
        backgroundColor: 'rgba(59, 130, 246, 0.5)',
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } },
      plugins: {
          legend: { display: false },
          tooltip: {
             callbacks: {
                label: function(context) {
                    return `Omzet: Rp ${formatRupiah(context.raw)}`;
                }
             }
          }
      }
    }
  });
}

function sortTable(key) {
    if (sortState.key === key) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        sortState.key = key;
        sortState.direction = (key === 'tanggal') ? 'desc' : 'asc';
    }
    showTabelRekap();
}

window.showTabelRekap = function(petani){
  const db = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
  petani = petani || document.getElementById('pilihPetani')?.value;
  const btnExport = document.getElementById('btnExportCsv');

  if(!petani) {
    document.getElementById('tabelRekap').innerHTML = "<p class='text-sm text-gray-500 text-center py-4'>Pilih seorang petani untuk melihat detail rekap.</p>";
    if (btnExport) btnExport.classList.add('hidden');
    return;
  }

  if (document.getElementById('pilihPetani')) {
      document.getElementById('pilihPetani').value = petani;
  }

  let trxList = db[petani] || [];

  const searchTerm = document.getElementById('rekapSearch')?.value.toLowerCase() || '';
  const tglMulai = document.getElementById('rekapMulai')?.value || '';
  const tglSelesai = document.getElementById('rekapSelesai')?.value || '';

  let filteredTrx = trxList.filter(trx => {
    const trxDate = trx.tanggal.slice(0, 10);
    if (tglMulai && trxDate < tglMulai) return false;
    if (tglSelesai && trxDate > tglSelesai) return false;
    if (searchTerm && !(trx.barang || []).some(b => b.nama.toLowerCase().includes(searchTerm))) return false;
    return true;
  });

  filteredTrx.sort((a, b) => {
    const dir = sortState.direction === 'asc' ? 1 : -1;
    switch (sortState.key) {
        case 'tanggal': return (new Date(a.tanggal) - new Date(b.tanggal)) * dir;
        case 'total': return (getTrxTotal(a) - getTrxTotal(b)) * dir;
        default: return 0;
    }
  });

  if(!filteredTrx.length) {
    document.getElementById('tabelRekap').innerHTML = "<p class='text-sm text-gray-500 text-center py-4'>Tidak ada data transaksi yang cocok dengan filter.</p>";
    btnExport.classList.add('hidden');
    return;
  }

  btnExport.classList.remove('hidden');

  const sortIndicator = (key) => {
    if (sortState.key === key) return sortState.direction === 'asc' ? ' â–²' : ' â–¼';
    return '';
  };

  let out = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-600">
    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
        <tr>
            <th class="px-4 py-3 align-top sortable" onclick="sortTable('tanggal')">Tanggal${sortIndicator('tanggal')}</th>
            <th class="px-4 py-3">Item</th>
            <th class="px-4 py-3 text-right align-top sortable" onclick="sortTable('total')">Total${sortIndicator('total')}</th>
            <th class="px-4 py-3 text-center align-top">Aksi</th>
        </tr>
    </thead>
    <tbody>`;

  let grandTotal = 0;
  filteredTrx.forEach((trx)=>{
    const originalIndex = trxList.findIndex(originalTrx => originalTrx.tanggal === trx.tanggal && JSON.stringify(originalTrx.barang) === JSON.stringify(trx.barang) );
    let totalPerTrx = getTrxTotal(trx);
    let itemSummary = (trx.barang||[]).filter(b => b.nama && b.qty).map(b => {
        let classes = "inline-block bg-gray-200 text-gray-800 text-xs font-semibold mr-1 mb-1 px-2.5 py-1 rounded-full";
        if(searchTerm && b.nama.toLowerCase().includes(searchTerm)) classes += " bg-yellow-200";
        return `<span class="${classes}">${b.nama} (${b.qty} ${b.satuan})</span>`;
      }).join(' ');

    out+=`<tr class="border-b odd:bg-white even:bg-gray-50">
        <td class="px-4 py-3 align-top">${formatTanggalNota(trx.tanggal||"")}</td>
        <td class="px-4 py-3">${itemSummary || '<i>(Tidak ada item)</i>'}</td>
        <td class="px-4 py-3 text-right align-top">${formatRupiah(totalPerTrx)}</td>
        <td class="px-4 py-3 text-center align-top whitespace-nowrap">
          <button class="font-medium text-blue-600 hover:underline" onclick="muatUlangTransaksi('${petani}', ${originalIndex})">Edit</button>
          <button class="font-medium text-red-600 hover:underline ml-3" onclick="hapusTransaksi('${petani}', ${originalIndex})">Hapus</button>
        </td>
      </tr>`;
    grandTotal += totalPerTrx;
  });
  out+=`<tr class="bg-gray-100 font-bold"><td colspan="2" class="px-4 py-3 text-right uppercase">GRAND TOTAL (setelah filter)</td><td class="px-4 py-3 text-right">${formatRupiah(grandTotal)}</td><td></td></tr>
    </tbody></table></div>`;
  document.getElementById('tabelRekap').innerHTML=out;
}

function exportToCSV() {
    const petani = document.getElementById('pilihPetani').value;
    if (!petani) { alert("Pilih petani terlebih dahulu!"); return; }
    const db = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
    const trxList = db[petani] || [];
    let grandTotal = 0;
    let csvContent = `Nama Toko:,"${document.getElementById('iNama').value}"\n`;
    csvContent += `Alamat:,"${document.getElementById('iAlamat').value}"\n`;
    csvContent += `No. WA:,"${document.getElementById('iTelp').value}"\n\n`;
    csvContent += "No. Trx,Nama Petani,Tanggal,Jam,Barang,Qty,Satuan,Harga,Subtotal\n";
    trxList.forEach((trx, i) => {
        (trx.barang || []).forEach(b => {
            const qty = parseFloatSafe(b.qty);
            const harga = parseFloatSafe(b.harga);
            const subtotal = qty * harga;
            grandTotal += subtotal;
            const line = [
                i + 1, `"${petani}"`,
                formatTanggalNota(trx.tanggal || "").split(" ")[0] || '',
                formatTanggalNota(trx.tanggal || "").split(" ")[1] || '',
                `"${(b.nama || '').replace(/"/g, '""')}"`,
                (b.qty || '0').replace('.',','),
                b.satuan || '', harga, subtotal
            ].join(',');
            csvContent += line + "\n";
        });
    });
    csvContent += `\n,,,,,,,GRAND TOTAL,${grandTotal}\n`;
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `rekap_${petani}_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function backupData() {
  const semuaData = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    semuaData[key] = localStorage.getItem(key);
  }
  const now = new Date();
  const tgl = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,'0') + "-" + String(now.getDate()).padStart(2,'0');
  const blob = new Blob([JSON.stringify(semuaData)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `backup-nota58-${tgl}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function importData(input) {
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    let data;
    try { data = JSON.parse(e.target.result); }
    catch(err) { alert("File backup tidak valid!"); return; }
    if(!data || typeof data !== "object"){ alert("Data backup tidak valid!"); return; }
    if (confirm("Ini akan menimpa SEMUA data yang ada. Lanjutkan?")) {
      localStorage.clear();
      for (const key in data) {
        if (Object.hasOwnProperty.call(data, key)) {
          localStorage.setItem(key, data[key]);
        }
      }
      alert("Data berhasil di-restore!");
      initForm();
      document.getElementById('rekapArea').innerHTML = '';
      document.getElementById('btnExportCsv').classList.add('hidden');
    }
  };
  reader.readAsText(file);
  input.value = '';
}

function saveConfig() {
    localStorage.setItem('conf_nama', document.getElementById('iNama').value);
    localStorage.setItem('conf_alamat', document.getElementById('iAlamat').value);
    localStorage.setItem('conf_telp', document.getElementById('iTelp').value);
}

document.getElementById('iNama').addEventListener('change', saveConfig);
document.getElementById('iAlamat').addEventListener('change', saveConfig);
document.getElementById('iTelp').addEventListener('change', saveConfig);

function checkAndShowBackupReminder() {
    const lastReminderTimestamp = parseInt(localStorage.getItem('conf_lastBackupReminderTimestamp') || '0');
    const transactionsSinceReminder = parseInt(localStorage.getItem('conf_transactionsSinceLastBackup') || '0');
    const twentyFourHours = 24 * 60 * 60 * 1000;

    const timeExceeded = (Date.now() - lastReminderTimestamp) > twentyFourHours;
    const transactionLimitReached = transactionsSinceReminder >= 3;

    if (timeExceeded || transactionLimitReached) {
        document.getElementById('backupReminder').classList.remove('hidden');
    }
}

function performBackupFromReminder() {
    backupData();
    localStorage.setItem('conf_lastBackupReminderTimestamp', Date.now());
    localStorage.setItem('conf_transactionsSinceLastBackup', '0');
    document.getElementById('backupReminder').classList.add('hidden');
}

function dismissBackupReminder() {
    localStorage.setItem('conf_lastBackupReminderTimestamp', Date.now());
    document.getElementById('backupReminder').classList.add('hidden');
}

initForm();
checkAndShowBackupReminder();
</script>

</body>
	</html>
